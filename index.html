<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reporte de FCI</title>
    
    <!-- Fuentes y Librerías -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Configuración de Colores Corporativos -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            navy: '#0f172a',   /* Azul Profundo */
                            gold: '#b45309',   /* Dorado/Bronce */
                            bg: '#f8fafc',
                            card: '#ffffff'
                        }
                    },
                    boxShadow: { 'soft': '0 2px 10px rgba(0, 0, 0, 0.03)' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f1f5f9; color: #0f172a; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // CONFIGURACIÓN (PEGAR ENLACES AQUÍ)
        // ==========================================
        
        // 1. Link de la hoja "Tenencias"
        const URL_TENENCIAS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2q5B__AcuBzjLoDUJPIrR0yyOa4BTcGuZjOMoJv9j55LsBTcKfFmai5qwkqAjsw/pub?gid=1204167854&single=true&output=csv";
        
        // 2. Link de la hoja "Suscripciones"
        const URL_SUSCRIPCIONES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2q5B__AcuBzjLoDUJPIrR0yyOa4BTcGuZjOMoJv9j55LsBTcKfFmai5qwkqAjsw/pub?gid=1189224573&single=true&output=csv"; 

        // 3. Link de la hoja "Rescates"
        const URL_RESCATES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2q5B__AcuBzjLoDUJPIrR0yyOa4BTcGuZjOMoJv9j55LsBTcKfFmai5qwkqAjsw/pub?gid=1665458748&single=true&output=csv";

        const LOGO_URL = "https://www.cafci.org.ar/images/cabezal_logo.png";

        // --- DATOS DEMO (Solo se usan si fallan los links) ---
        const DEMO_TENENCIAS = `Moneda,Fecha,Cuenta,Unidad,Importe,FCI
USD,2025-01-01,Cuenta A,Galileo Income,3457.58,GALILEO
ARS,2025-01-01,Cuenta A,ADCAP RENT,242610.11,ADCAP
USD,2025-01-01,Cuenta B,Galileo Event,14511.63,GALILEO`;

        const DEMO_SUSCRIPCIONES = `Moneda,Fecha,FCI,Importe
ARS,2025-05-15,ADCAP,500000
USD,2025-05-15,GALILEO,2000`;

        const DEMO_RESCATES = `Moneda,Fecha,FCI,Importe
ARS,2025-05-14,ADCAP,200000
USD,2025-05-16,GALILEO,1000`;

        // ==========================================
        // CÓDIGO
        // ==========================================
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell, AreaChart, Area, ReferenceLine } = Recharts;

        // Iconos
        const Icon = ({ path, className }) => ( <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={path} /></svg> );
        const Icons = {
            Wallet: (props) => <Icon {...props} path="M20 7h-3a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h3a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM4 9h16" />,
            DollarSign: (props) => <Icon {...props} path="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />,
            PieChart: (props) => <Icon {...props} path="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z" />,
            BarChart2: (props) => <Icon {...props} path="M18 20V10M12 20V4M6 20v-6" />,
            Filter: (props) => <Icon {...props} path="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" />,
            Calendar: (props) => <Icon {...props} path="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zM16 2v4M8 2v4M3 10h18" />,
            RefreshCcw: (props) => <Icon {...props} path="M3 2v6h6M21 12A9 9 0 0 0 6 5.3L3 8M21 22v-6h-6M3 12a9 9 0 0 0 15 6.7l3-2.7" />,
            Loader2: (props) => <svg {...props} className={`animate-spin ${props.className}`} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>,
            ExternalLink: (props) => <Icon {...props} path="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3" />,
            ChevronDown: (props) => <Icon {...props} path="M6 9l6 6 6-6" />,
            ChevronRight: (props) => <Icon {...props} path="M9 18l6-6-6-6" />,
            TrendingUp: (props) => <Icon {...props} path="M23 6l-9.5 9.5-5-5L1 18" />,
            Activity: (props) => <Icon {...props} path="M22 12h-4l-3 9L9 3l-3 9H2" />
        };

        const COLORS = ['#0f172a', '#334155', '#475569', '#64748b', '#b45309', '#d97706', '#f59e0b', '#fbbf24'];

        // --- COMPONENTES ---
        const Card = ({ children, className = "" }) => ( <div className={`bg-white rounded-lg shadow-soft border border-slate-200 ${className}`}>{children}</div> );

        const StatCard = ({ title, value, prefix, icon: Icon }) => (
            <Card className="p-4 sm:p-6 border-l-4 border-brand-navy relative overflow-hidden group hover:shadow-md transition-all">
                <div className="mb-1 sm:mb-2 relative z-10">
                    <h3 className="text-xs sm:text-sm font-bold text-slate-500 uppercase tracking-widest">{title}</h3>
                </div>
                <div className="flex items-baseline gap-1 relative z-10">
                    <span className="text-xl sm:text-2xl font-bold text-brand-gold">{prefix}</span>
                    <span className="text-2xl sm:text-4xl font-bold text-brand-navy tracking-tight">{value}</span>
                </div>
                <div className="absolute top-4 right-4 text-slate-100 opacity-50 group-hover:opacity-100 group-hover:text-slate-200 transition-all transform group-hover:scale-110">
                    <Icon size={32} className="sm:w-12 sm:h-12" />
                </div>
            </Card>
        );

        const FilterBar = ({ 
            title, currencies, managers, currencyVal, setCurrency, 
            managerVal, setManager, 
            startDate, setStartDate, endDate, setEndDate,
            reportDate, setReportDate, 
            isRange = true,
            isFlow = false 
        }) => (
            <div className="bg-white px-4 py-4 sm:px-5 rounded-lg shadow-soft border border-slate-200 flex flex-col md:flex-row flex-wrap gap-4 items-end md:items-center mb-6 sm:mb-8">
                <div className="flex items-center gap-2 text-brand-navy font-bold w-full md:w-auto border-b md:border-b-0 pb-2 md:pb-0 md:pr-4 md:border-r border-slate-200">
                    <Icons.Filter size={16} /> <span className="text-sm">{title}</span>
                </div>
                
                {!isFlow && (
                    <div className="grid grid-cols-2 gap-3 w-full md:w-auto md:flex md:gap-4">
                        <div className="flex flex-col gap-1 w-full md:w-auto col-span-1">
                            <label className="text-[10px] text-slate-500 font-bold uppercase ml-1">Moneda</label>
                            <select value={currencyVal} onChange={(e) => setCurrency(e.target.value)} className="bg-slate-50 border border-slate-300 text-brand-navy text-sm rounded hover:border-brand-gold focus:ring-1 focus:ring-brand-gold block p-2 outline-none w-full">
                                {currencies.map(c => <option key={c} value={c}>{c === 'TODAS' ? 'Todas' : c}</option>)}
                            </select>
                        </div>
                        <div className="flex flex-col gap-1 w-full md:w-auto col-span-1">
                            <label className="text-[10px] text-slate-500 font-bold uppercase ml-1">Administradora</label>
                            <select value={managerVal} onChange={(e) => setManager(e.target.value)} className="bg-slate-50 border border-slate-300 text-brand-navy text-sm rounded hover:border-brand-gold focus:ring-1 focus:ring-brand-gold block p-2 outline-none w-full md:w-48">
                                {managers.map(m => <option key={m} value={m}>{m === 'TODAS' ? 'Todas' : m}</option>)}
                            </select>
                        </div>
                    </div>
                )}

                {isRange ? (
                    <div className="grid grid-cols-2 gap-3 w-full md:w-auto md:flex md:gap-4">
                        <div className="flex flex-col gap-1 w-full md:w-auto">
                            <label className="text-[10px] text-slate-500 font-bold uppercase ml-1">Desde</label>
                            <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="bg-slate-50 border border-slate-300 text-brand-navy text-sm rounded hover:border-brand-gold focus:ring-1 focus:ring-brand-gold block p-1.5 outline-none w-full"/>
                        </div>
                        <div className="flex flex-col gap-1 w-full md:w-auto">
                            <label className="text-[10px] text-slate-500 font-bold uppercase ml-1">Hasta</label>
                            <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="bg-slate-50 border border-slate-300 text-brand-navy text-sm rounded hover:border-brand-gold focus:ring-1 focus:ring-brand-gold block p-1.5 outline-none w-full"/>
                        </div>
                    </div>
                ) : (
                    <div className="flex flex-col gap-1 w-full md:w-auto">
                        <label className="text-[10px] text-slate-500 font-bold uppercase ml-1 flex items-center gap-1"><Icons.Calendar size={10}/> Fecha de Reporte</label>
                        <input type="date" value={reportDate} onChange={(e) => setReportDate(e.target.value)} className="bg-slate-50 border border-slate-300 text-brand-navy text-sm rounded hover:border-brand-gold focus:ring-1 focus:ring-brand-gold block p-1.5 outline-none font-bold w-full"/>
                    </div>
                )}
                
                <button onClick={() => { 
                    setCurrency('TODAS'); 
                    setManager('TODAS'); 
                    if(isRange) { setStartDate(''); setEndDate(''); } 
                }} className="w-full md:w-auto ml-auto text-xs font-semibold text-brand-gold hover:text-orange-700 flex items-center justify-center gap-1 px-3 py-2 bg-orange-50 rounded hover:bg-orange-100 transition-colors mt-2 md:mt-0">
                    <Icons.RefreshCcw size={12}/> Reiniciar
                </button>
            </div>
        );

        // --- HELPERS ---
        const parseDateValue = (val) => {
            if (!val) return null;
            if (typeof val === 'number') return new Date((val - (25567 + 2)) * 86400 * 1000);
            if (typeof val === 'string') {
                if (val.includes('-')) { const parts = val.split('-'); if (parts[0].length === 4) return new Date(val); if (parts[2].length === 4) return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); }
                if (val.includes('/')) { const parts = val.split('/'); if (parts.length === 3) return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); }
            }
            const d = new Date(val); return isNaN(d) ? null : d;
        };

        const formatDateString = (dateObj) => {
            if (!dateObj || isNaN(dateObj)) return '';
            return dateObj.toISOString().split('T')[0];
        };

        const normalizeCurrency = (curr) => {
            if (!curr) return 'OTHER';
            const c = String(curr).toUpperCase().trim();
            if (c === 'ARS' || c === 'PESOS' || c === 'PESO' || c === '$') return 'ARS';
            if (c === 'USD' || c === 'USDM' || c === 'DOLARES' || c === 'DOLAR' || c === 'U$S' || c === 'US$') return 'USD';
            return 'OTHER';
        };

        const parseCSV = (text) => {
            const lines = text.trim().split('\n'); if (lines.length < 2) return [];
            const separator = lines[0].includes(';') ? ';' : ',';
            const splitLine = (line) => {
                const result = []; let current = ''; let insideQuotes = false;
                for (let i = 0; i < line.length; i++) { const char = line[i]; if (char === '"') insideQuotes = !insideQuotes; else if (char === separator && !insideQuotes) { result.push(current.trim()); current = ''; } else current += char; }
                result.push(current.trim()); return result;
            };
            const headers = splitLine(lines[0]).map(h => h.toLowerCase().replace(/['"]+/g, '').trim());
            const findValue = (rowObj, aliases) => { for (let alias of aliases) if (rowObj[alias] !== undefined) return rowObj[alias]; return ''; };
            return lines.slice(1).map(line => {
                if (!line.trim()) return null; const values = splitLine(line); const entry = {};
                headers.forEach((h, i) => { let val = values[i] ? values[i].replace(/^"|"$/g, '') : ''; entry[h] = val; });
                
                let rawImporte = findValue(entry, ['importe', 'valor', 'monto', 'saldo']);
                if (typeof rawImporte === 'string') rawImporte = rawImporte.replace(/[$.]/g, '').replace(',', '.');
                
                const rawMoneda = findValue(entry, ['moneda']);
                const normalizedMoneda = normalizeCurrency(rawMoneda);

                let rawFci = findValue(entry, ['fci', 'administradora', 'fondos.fci', 'sociedad gerente', 'familia', 'family']) || 'OTRO';
                rawFci = rawFci.toUpperCase().trim();

                let detalle = findValue(entry, ['detalle', 'descripcion', 'nombre', 'fondo detalle']);

                return {
                    Moneda: normalizedMoneda, 
                    Fecha: findValue(entry, ['fecha']), 
                    Unidad: findValue(entry, ['unidad', 'fondo', 'especie', 'activo']),
                    Importe: parseFloat(rawImporte || 0), 
                    FCI: rawFci,
                    Detalle: detalle
                };
            }).filter(item => item && !isNaN(item.Importe));
        };

        const formatCurrency = (val) => new Intl.NumberFormat('es-AR', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
        const formatCompact = (val) => new Intl.NumberFormat('es-AR', { notation: "compact", compactDisplay: "short" }).format(val);
        const formatPct = (val) => { if (val === 0 || isNaN(val)) return '-'; const sign = val > 0 ? '+' : ''; return `${sign}${val.toFixed(2)}%`; };

        // --- APP PRINCIPAL ---
        function App() {
            const [data, setData] = useState([]);
            const [dataSubs, setDataSubs] = useState([]);
            const [dataRedem, setDataRedem] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            
            // Filtros
            const [totalCurrency, setTotalCurrency] = useState('TODAS');
            const [totalManager, setTotalManager] = useState('TODAS');
            const [reportDate, setReportDate] = useState('');

            // Filtros Flujo
            const [flowStart, setFlowStart] = useState('');
            const [flowEnd, setFlowEnd] = useState('');

            // UI States
            const [expandedFamilies, setExpandedFamilies] = useState([]);
            const [volumeCurrency, setVolumeCurrency] = useState('ARS'); 
            const [historyCurrency, setHistoryCurrency] = useState('ALL');
            const [flowCurrency, setFlowCurrency] = useState('ARS');

            const toggleFamily = (familyName) => { setExpandedFamilies(prev => prev.includes(familyName) ? prev.filter(f => f !== familyName) : [...prev, familyName]); };

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                
                async function fetchAll() {
                    setLoading(true);
                    try {
                        let csvTenencias = DEMO_TENENCIAS;
                        if (URL_TENENCIAS) { const res = await fetch(URL_TENENCIAS); if(res.ok) csvTenencias = await res.text(); }
                        const parsedData = parseCSV(csvTenencias); setData(parsedData);
                        if (parsedData.length > 0) {
                            const maxTime = parsedData.reduce((max, curr) => { const d = parseDateValue(curr.Fecha); return d && d.getTime() > max ? d.getTime() : max; }, 0);
                            if (maxTime > 0) {
                                const maxDate = new Date(maxTime);
                                setReportDate(formatDateString(maxDate));
                                
                                // Default dates for flow
                                setFlowEnd(formatDateString(maxDate));
                                const past = new Date(maxDate);
                                past.setDate(past.getDate() - 30);
                                setFlowStart(formatDateString(past));
                            }
                        }

                        let csvSubs = DEMO_SUSCRIPCIONES;
                        if (URL_SUSCRIPCIONES) { const res = await fetch(URL_SUSCRIPCIONES); if(res.ok) csvSubs = await res.text(); }
                        setDataSubs(parseCSV(csvSubs));

                        let csvRedem = DEMO_RESCATES;
                        if (URL_RESCATES) { const res = await fetch(URL_RESCATES); if(res.ok) csvRedem = await res.text(); }
                        setDataRedem(parseCSV(csvRedem));

                    } catch (err) { console.error(err); } finally { setLoading(false); }
                }
                fetchAll();
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const currencies = useMemo(() => ['TODAS', ...new Set(data.map(d => d.Moneda))].filter(Boolean), [data]);
            const managers = useMemo(() => ['TODAS', ...new Set(data.map(d => d.FCI))].filter(Boolean), [data]);

            // Filtros
            const filteredTotalData = useMemo(() => {
                let result = data;
                if (totalCurrency !== 'TODAS') result = result.filter(d => d.Moneda === totalCurrency);
                if (totalManager !== 'TODAS') result = result.filter(d => d.FCI === totalManager);
                if (reportDate) { result = result.filter(d => { const dDate = parseDateValue(d.Fecha); if (!dDate) return false; return formatDateString(dDate) === reportDate; }); }
                return result;
            }, [data, totalCurrency, totalManager, reportDate]);

            const filteredEvolData = useMemo(() => {
                let result = data;
                if (totalManager !== 'TODAS') result = result.filter(d => d.FCI === totalManager);
                return result;
            }, [data, totalManager]);

            const flowData = useMemo(() => {
                const aggregations = {};
                const start = flowStart ? new Date(flowStart).getTime() : 0;
                const end = flowEnd ? new Date(flowEnd).getTime() + 86400000 : Infinity;

                const processFlow = (dataset, type) => {
                    dataset.forEach(row => {
                        if (flowCurrency === 'ARS' && row.Moneda !== 'ARS') return;
                        if (flowCurrency === 'USD' && row.Moneda !== 'USD') return;
                        if (totalManager !== 'TODAS' && row.FCI !== totalManager) return;
                        
                        const rowDate = parseDateValue(row.Fecha);
                        if (!rowDate) return;
                        const rowTime = rowDate.getTime();
                        if (rowTime < start || rowTime > end) return;

                        const mgr = row.FCI || 'OTROS';
                        if (!aggregations[mgr]) aggregations[mgr] = { name: mgr, Subs: 0, Redem: 0 };
                        
                        const val = Math.abs(row.Importe);
                        
                        if (type === 'sub') aggregations[mgr].Subs += val;
                        // Acumulamos el rescate como negativo para que se dibuje hacia abajo en Recharts
                        if (type === 'red') aggregations[mgr].Redem -= val; 
                    });
                };
                processFlow(dataSubs, 'sub'); 
                processFlow(dataRedem, 'red');
                
                return Object.values(aggregations)
                    .map(item => ({ 
                        ...item, 
                        RedemNegative: item.Redem // Ensure this key exists for the chart
                    }))
                    .filter(item => item.Subs > 0 || item.Redem < 0)
                    .sort((a,b) => (b.Subs + Math.abs(b.Redem)) - (a.Subs + Math.abs(a.Redem)));
            }, [dataSubs, dataRedem, flowCurrency, totalManager, flowStart, flowEnd]);

            const stats = useMemo(() => {
                const totalImporteARS = filteredTotalData.filter(d => d.Moneda === 'ARS').reduce((acc, curr) => acc + curr.Importe, 0);
                const totalImporteUSD = filteredTotalData.filter(d => d.Moneda === 'USD').reduce((acc, curr) => acc + curr.Importe, 0);
                return { totalImporteARS, totalImporteUSD };
            }, [filteredTotalData]);

            const managerData = useMemo(() => {
                const grouped = filteredTotalData.reduce((acc, curr) => {
                    let mgr = curr.FCI || 'OTROS'; mgr = mgr.toString().trim().toUpperCase();
                    if (!acc[mgr]) acc[mgr] = { name: mgr, ARS: 0, USD: 0 };
                    if (curr.Moneda === 'ARS') acc[mgr].ARS += curr.Importe; else if (curr.Moneda === 'USD') acc[mgr].USD += curr.Importe;
                    return acc;
                }, {});
                return Object.values(grouped).map(item => ({ name: item.name, value: volumeCurrency === 'ARS' ? item.ARS : item.USD })).filter(item => item.value > 0).sort((a, b) => b.value - a.value);
            }, [filteredTotalData, volumeCurrency]);

            const groupedVariations = useMemo(() => {
                if (data.length === 0) return [];
                let refDate = reportDate ? new Date(reportDate) : new Date();
                refDate.setHours(23, 59, 59, 999);
                const d7 = new Date(refDate); d7.setDate(d7.getDate() - 7);
                const d28 = new Date(refDate); d28.setDate(d28.getDate() - 28);
                const dYTD = new Date(refDate.getFullYear(), 0, 1);
                
                const historyByFund = {};
                const relevantData = data.filter(d => { if (totalCurrency !== 'TODAS' && d.Moneda !== totalCurrency) return false; return true; });
                relevantData.forEach(d => {
                    const fname = d.Unidad.trim(); const fdate = parseDateValue(d.Fecha); if (!fdate) return; fdate.setHours(0,0,0,0); const timeKey = fdate.getTime();
                    if (!historyByFund[fname]) historyByFund[fname] = [];
                    const existingIdx = historyByFund[fname].findIndex(h => h.time === timeKey);
                    // Guardar 'Detalle' si existe para usarlo en nombre
                    if (existingIdx >= 0) historyByFund[fname][existingIdx].val += d.Importe; else historyByFund[fname].push({ time: timeKey, val: d.Importe, moneda: d.Moneda, fci: d.FCI, detalle: d.Detalle });
                });
                Object.keys(historyByFund).forEach(k => historyByFund[k].sort((a,b) => a.time - b.time));

                const fundMetrics = [];
                Object.keys(historyByFund).forEach(fname => {
                    const hist = historyByFund[fname]; const meta = hist[hist.length-1];
                    const currentEntry = hist.filter(h => h.time <= refDate.getTime()).pop(); const currentVal = currentEntry ? currentEntry.val : 0;
                    if (currentVal === 0) return;
                    const findValAt = (tDate) => { const tTime = tDate.getTime(); const e = hist.filter(h => h.time <= tTime).pop(); return e ? e.val : 0; };
                    const v7 = findValAt(d7); const v28 = findValAt(d28); const vYTD = findValAt(dYTD);
                    
                    const displayName = meta.detalle && meta.detalle.length > 2 ? meta.detalle : fname;

                    fundMetrics.push({ name: displayName, moneda: meta.moneda, fci: meta.fci || 'OTROS', current: currentVal, diff7d: currentVal - v7, pct7d: v7 > 0 ? ((currentVal - v7)/v7)*100 : 0, diff28d: currentVal - v28, pct28d: v28 > 0 ? ((currentVal - v28)/v28)*100 : 0, diffYTD: currentVal - vYTD, pctYTD: vYTD > 0 ? ((currentVal - vYTD)/vYTD)*100 : 0 });
                });

                const groups = {};
                fundMetrics.forEach(fund => {
                    if (totalManager !== 'TODAS' && fund.fci !== totalManager) return;
                    const key = fund.fci; if (!groups[key]) groups[key] = { name: key, current: 0, val7d: 0, val28d: 0, valYTD: 0, funds: [] };
                    groups[key].funds.push(fund);
                    groups[key].current += fund.current;
                    groups[key].val7d += (fund.current - fund.diff7d);
                    groups[key].val28d += (fund.current - fund.diff28d);
                    groups[key].valYTD += (fund.current - fund.diffYTD);
                });
                return Object.values(groups).map(g => ({ ...g, diff7d: g.current - g.val7d, pct7d: g.val7d > 0 ? ((g.current - g.val7d)/g.val7d)*100 : 0, diff28d: g.current - g.val28d, pct28d: g.val28d > 0 ? ((g.current - g.val28d)/g.val28d)*100 : 0, diffYTD: g.current - g.valYTD, pctYTD: g.valYTD > 0 ? ((g.current - g.valYTD)/g.valYTD)*100 : 0, funds: g.funds.sort((a,b) => b.current - a.current) })).sort((a,b) => b.current - a.current);
            }, [data, totalCurrency, totalManager, reportDate]);

            const timelineData = useMemo(() => {
                const monthMaxDates = {}; filteredEvolData.forEach(curr => { const d = parseDateValue(curr.Fecha); if (!d) return; const monthKey = d.toISOString().substring(0, 7); const time = d.getTime(); if (!monthMaxDates[monthKey] || time > monthMaxDates[monthKey]) monthMaxDates[monthKey] = time; });
                const grouped = filteredEvolData.reduce((acc, curr) => {
                    const d = parseDateValue(curr.Fecha); if (!d) return acc; const monthKey = d.toISOString().substring(0, 7);
                    if (d.getTime() === monthMaxDates[monthKey]) {
                        if (!acc[monthKey]) acc[monthKey] = { date: monthKey, ARS: 0, USD: 0 };
                        if (curr.Moneda === 'ARS') acc[monthKey].ARS += curr.Importe; if (curr.Moneda === 'USD') acc[monthKey].USD += curr.Importe;
                    }
                    return acc;
                }, {});
                return Object.values(grouped).sort((a, b) => a.date.localeCompare(b.date));
            }, [filteredEvolData]);

            const topFundsData = useMemo(() => {
                const grouped = filteredTotalData.reduce((acc, curr) => {
                    const fundName = curr.Detalle || curr.Unidad || 'Desc'; 
                    const key = fundName.trim();
                    if (!acc[key]) acc[key] = { name: fundName, value: 0, fci: curr.FCI, moneda: curr.Moneda };
                    acc[key].value += curr.Importe; return acc;
                }, {});
                return Object.values(grouped).sort((a, b) => b.value - a.value).slice(0, 10);
            }, [filteredTotalData]);

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500"><Icons.Loader2 className="mr-2"/> Cargando...</div>;

            return (
                <div className="min-h-screen bg-slate-50 font-sans pb-12">
                    <header className="bg-white border-b-2 border-brand-gold sticky top-0 z-20 px-4 sm:px-6 py-4 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-4 sm:gap-6 max-w-7xl mx-auto w-full">
                            <img src={LOGO_URL} alt="Logo" className="h-8 sm:h-10 object-contain" onError={(e) => e.target.style.display = 'none'} />
                            <div className="h-6 sm:h-8 w-px bg-slate-200"></div>
                            <div>
                                <h1 className="text-lg sm:text-xl font-bold text-brand-navy tracking-tight">REPORTE DE FCI</h1>
                            </div>
                        </div>
                    </header>

                    <main className="p-4 sm:p-6 max-w-7xl mx-auto space-y-6 sm:space-y-8 mt-2 sm:mt-4">
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                            <StatCard title="TOTAL PESOS" value={formatCurrency(stats.totalImporteARS)} prefix="$" icon={Icons.Wallet} />
                            <StatCard title="TOTAL DÓLARES" value={formatCurrency(stats.totalImporteUSD)} prefix="US$" icon={Icons.DollarSign} />
                        </div>

                        <div>
                            <div className="flex items-center gap-2 mb-3 px-1"><div className="h-4 w-1 bg-brand-gold rounded-full"></div><h2 className="text-lg font-bold text-brand-navy">Composición y Ranking</h2></div>
                            <FilterBar title="Filtros Generales" currencies={currencies} managers={managers} currencyVal={totalCurrency} setCurrency={setTotalCurrency} managerVal={totalManager} setManager={setTotalManager} reportDate={reportDate} setReportDate={setReportDate} isRange={false} />
                        </div>

                        <div className="grid grid-cols-1 mb-6 sm:mb-8">
                            <Card className="p-4 sm:p-6">
                                <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 border-b border-slate-100 pb-3 gap-3">
                                    <h3 className="text-base font-bold text-brand-navy flex items-center gap-2"><Icons.PieChart className="text-brand-gold" />Saldo en Custodia por Familia</h3>
                                    <div className="flex bg-slate-100 rounded-lg p-1 self-start sm:self-auto">
                                        <button onClick={() => setVolumeCurrency('ARS')} className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${volumeCurrency === 'ARS' ? 'bg-brand-navy text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>PESOS ($)</button>
                                        <button onClick={() => setVolumeCurrency('USD')} className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${volumeCurrency === 'USD' ? 'bg-brand-gold text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>DÓLARES (US$)</button>
                                    </div>
                                </div>
                                <div className="h-[300px] sm:h-[350px] w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={managerData} margin={{ top: 10, right: 10, left: 10, bottom: 30 }}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <XAxis dataKey="name" tick={!isMobile ? {fontSize: 10, fill: '#1e293b'} : false} interval={0} angle={-45} textAnchor="end" height={80} tickFormatter={(val) => val.length > 12 ? val.substring(0, 12) + '..' : val} />
                                            <YAxis tickFormatter={(val) => formatCompact(val)} tick={{fontSize: 10, fill: '#64748b'}} axisLine={false} tickLine={false} width={40} />
                                            <RechartsTooltip cursor={{fill: '#f1f5f9'}} formatter={(value) => [formatCurrency(value), volumeCurrency === 'ARS' ? 'Total $' : 'Total US$']} contentStyle={{ borderRadius: '4px', border: '1px solid #e2e8f0', boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)' }} />
                                            <Bar dataKey="value" fill={volumeCurrency === 'ARS' ? '#0f172a' : '#b45309'} radius={[4, 4, 0, 0]} maxBarSize={50} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </Card>
                        </div>

                        {/* SECCIÓN FLUJO DE FONDOS (STACKED BIDIRECCIONAL) */}
                        <div className="grid grid-cols-1 mb-8">
                            <Card className="p-4 sm:p-6">
                                <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 border-b border-slate-100 pb-3 gap-3">
                                    <h3 className="text-base font-bold text-brand-navy flex items-center gap-2"><Icons.Activity className="text-brand-gold" />Flujo de Fondos (Semanal)</h3>
                                    <div className="flex bg-slate-100 rounded-lg p-1 self-start sm:self-auto">
                                        <button onClick={() => setFlowCurrency('ARS')} className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${flowCurrency === 'ARS' ? 'bg-brand-navy text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>PESOS ($)</button>
                                        <button onClick={() => setFlowCurrency('USD')} className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${flowCurrency === 'USD' ? 'bg-brand-gold text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>DÓLARES (US$)</button>
                                    </div>
                                </div>
                                
                                {/* FILTRO DE FECHA EXCLUSIVO PARA FLUJO */}
                                <FilterBar title="Rango de Fechas" currencies={currencies} managers={managers} currencyVal={totalCurrency} setCurrency={setTotalCurrency} managerVal={totalManager} setManager={setTotalManager} startDate={flowStart} setStartDate={setFlowStart} endDate={flowEnd} setEndDate={setFlowEnd} isRange={true} isFlow={true} />

                                <div className="h-[350px] w-full mt-4">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={flowData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }} stackOffset="sign">
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <XAxis dataKey="name" tick={!isMobile ? {fontSize: 10, fill: '#64748b'} : false} interval={0} angle={-45} textAnchor="end" height={60} />
                                            <YAxis tickFormatter={(val) => formatCompact(Math.abs(val))} tick={{fontSize: 10, fill: '#64748b'}} axisLine={false} tickLine={false} width={40}/>
                                            
                                            {/* TOOLTIP MEJORADO */}
                                            <RechartsTooltip
                                              content={({ active, payload }) => {
                                                if (!active || !payload || payload.length === 0) return null;

                                                const row = payload[0].payload;
                                                const subs = Math.abs(row.Subs || 0);
                                                const redem = Math.abs(row.RedemNegative || 0);
                                                const net = (row.Subs || 0) + (row.RedemNegative || 0);

                                                return (
                                                  <div style={{ background: "white", border: "1px solid #e2e8f0", borderRadius: 6, padding: 10, boxShadow: "0 4px 6px -1px rgba(0,0,0,0.1)" }}>
                                                    <div style={{ fontWeight: 700, marginBottom: 6, color: "#0f172a", borderBottom: "1px solid #f1f5f9", paddingBottom: 4 }}>
                                                      {row.name}
                                                    </div>

                                                    <div style={{ color: "#059669", fontWeight: 600, fontSize: "12px", marginBottom: 2 }}>
                                                      Suscripciones: {formatCurrency(subs)}
                                                    </div>

                                                    <div style={{ color: "#dc2626", fontWeight: 600, fontSize: "12px" }}>
                                                      Rescates: {formatCurrency(redem)}
                                                    </div>

                                                    <div style={{ borderTop: "1px solid #e2e8f0", marginTop: 8, paddingTop: 6, fontWeight: 800, color: "#1e293b", fontSize: "13px" }}>
                                                      Neto: <span style={{ color: net >= 0 ? "#059669" : "#dc2626" }}>{formatCurrency(net)}</span>
                                                    </div>
                                                  </div>
                                                );
                                              }}
                                            />
                                            
                                            <Legend verticalAlign="top" height={36} iconType="circle"/>
                                            <ReferenceLine y={0} stroke="#000" />
                                            <Bar name="Suscripciones" dataKey="Subs" stackId="a" fill="#059669" radius={[4, 4, 0, 0]} maxBarSize={40} />
                                            <Bar name="Rescates" dataKey="RedemNegative" stackId="a" fill="#dc2626" radius={[0, 0, 4, 4]} maxBarSize={40} /> 
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </Card>
                        </div>

                        {/* Tabla de Rendimiento (Corregida) */}
                        <div className="grid grid-cols-1 gap-4 sm:gap-6 mb-8 sm:mb-12">
                            <Card className="overflow-hidden">
                                <div className="px-4 sm:px-6 py-4 border-b border-slate-200 flex items-center justify-between">
                                    <h3 className="text-base sm:text-lg font-bold text-slate-800 flex items-center gap-2"><Icons.TrendingUp size={20} className="text-purple-500" />Variación por Familia</h3>
                                    <div className="text-xs text-slate-400 hidden sm:block">Clic para ver fondos</div>
                                </div>
                                <div className="overflow-x-auto overflow-y-auto max-h-[600px] custom-scrollbar">
                                    <table className="w-full text-xs sm:text-sm text-left text-slate-900 relative">
                                        <thead className="text-xs text-white uppercase bg-brand-navy sticky top-0 z-10">
                                            <tr>
                                                <th className="px-4 sm:px-6 py-3 min-w-[180px] sm:min-w-[200px]">Familia / Fondo</th>
                                                <th className="px-4 sm:px-6 py-3 text-right">Actual</th>
                                                <th className="px-2 py-3 text-center border-l border-white/20" colSpan="2">7 Días</th>
                                                <th className="px-2 py-3 text-center border-l border-white/20" colSpan="2">28 Días</th>
                                                <th className="px-2 py-3 text-center border-l border-white/20" colSpan="2">YTD (Año)</th>
                                            </tr>
                                            <tr className="bg-slate-200 text-slate-600 font-bold border-b border-slate-300 text-[10px]">
                                                <th className="py-1"></th>
                                                <th className="py-1"></th>
                                                <th className="text-right px-2 py-1 border-l border-slate-300">Dif ($)</th>
                                                <th className="text-right px-2 py-1">%</th>
                                                <th className="text-right px-2 py-1 border-l border-slate-300">Dif ($)</th>
                                                <th className="text-right px-2 py-1">%</th>
                                                <th className="text-right px-2 py-1 border-l border-slate-300">Dif ($)</th>
                                                <th className="text-right px-2 py-1">%</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-200 bg-white">
                                            {groupedVariations.map((family) => (
                                                <React.Fragment key={family.name}>
                                                    <tr className="bg-slate-900 cursor-pointer transition-colors border-b border-slate-200" onClick={() => toggleFamily(family.name)}>
                                                        <td className="px-4 sm:px-6 py-3 flex items-center gap-2 font-bold text-white">
                                                            {expandedFamilies.includes(family.name) ? <Icons.ChevronDown size={14} className="text-brand-gold"/> : <Icons.ChevronRight size={14} className="text-brand-gold"/>}
                                                            {family.name}
                                                        </td>
                                                        <td className="px-4 sm:px-6 py-3 text-right font-bold text-white">{formatCurrency(family.current)}</td>
                                                        <td className={`px-2 py-3 text-right border-l border-slate-700 ${family.diff7d >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{formatCurrency(family.diff7d)}</td>
                                                        <td className={`px-2 py-3 text-right ${family.pct7d >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{formatPct(family.pct7d)}</td>
                                                        <td className={`px-2 py-3 text-right border-l border-slate-700 ${family.diff28d >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{formatCurrency(family.diff28d)}</td>
                                                        <td className={`px-2 py-3 text-right ${family.pct28d >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{formatPct(family.pct28d)}</td>
                                                        <td className={`px-2 py-3 text-right border-l border-slate-700 ${family.diffYTD >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{formatCurrency(family.diffYTD)}</td>
                                                        <td className={`px-2 py-3 text-right ${family.pctYTD >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{formatPct(family.pctYTD)}</td>
                                                    </tr>
                                                    {expandedFamilies.includes(family.name) && family.funds.map(fund => (
                                                        <tr key={fund.name} className="bg-slate-50/50 hover:bg-slate-100 border-b border-slate-100 text-xs">
                                                            <td className="px-4 sm:px-6 py-2 pl-8 sm:pl-10 text-slate-700 border-l-4 border-slate-300">
                                                                <div className="font-medium whitespace-normal text-gray-800">{fund.name}</div>
                                                                <div className="text-[9px] sm:text-[10px] text-slate-500 font-semibold">{fund.moneda}</div>
                                                            </td>
                                                            <td className="px-4 sm:px-6 py-2 text-right text-gray-800 font-medium">{formatCurrency(fund.current)}</td>
                                                            <td className={`px-2 py-2 text-right border-l border-slate-200 ${fund.diff7d >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{formatCurrency(fund.diff7d)}</td>
                                                            <td className={`px-2 py-2 text-right ${fund.pct7d >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{formatPct(fund.pct7d)}</td>
                                                            <td className={`px-2 py-2 text-right border-l border-slate-200 ${fund.diff28d >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{formatCurrency(fund.diff28d)}</td>
                                                            <td className={`px-2 py-2 text-right ${fund.pct28d >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{formatPct(fund.pct28d)}</td>
                                                            <td className={`px-2 py-2 text-right border-l border-slate-200 ${fund.diffYTD >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{formatCurrency(fund.diffYTD)}</td>
                                                            <td className={`px-2 py-2 text-right ${fund.pctYTD >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{formatPct(fund.pctYTD)}</td>
                                                        </tr>
                                                    ))}
                                                </React.Fragment>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>

                        {/* Top 10 y Evolución */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                            <Card className="p-4 sm:p-6">
                                <h3 className="text-base font-bold text-brand-navy mb-6 flex items-center gap-2 border-b border-slate-100 pb-3"><Icons.BarChart2 className="text-brand-gold" />Top 10 FCI</h3>
                                <div className="h-[300px] sm:h-[350px] w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={topFundsData} layout="vertical" margin={{ top: 10, right: 10, left: 10, bottom: 5 }}>
                                            <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                                            <XAxis type="number" hide />
                                            <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 10, fill: '#475569', fontWeight: 500}} tickFormatter={(val) => val.length > 15 ? val.substring(0, 15) + '...' : val} />
                                            <RechartsTooltip cursor={{fill: '#f8fafc'}} formatter={(value) => [formatCurrency(value), 'Volumen']} contentStyle={{ borderRadius: '4px', border: '1px solid #e2e8f0' }} />
                                            <Bar dataKey="value" fill="#b45309" radius={[0, 4, 4, 0]} barSize={20}>
                                                {topFundsData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[(index + 1) % COLORS.length]} />)}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </Card>

                            <Card className="p-4 sm:p-6">
                                <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 border-b border-slate-100 pb-3 gap-3">
                                    <h3 className="text-base font-bold text-brand-navy flex items-center gap-2"><Icons.TrendingUp className="text-brand-gold" />Evolución Histórica</h3>
                                    <div className="flex bg-slate-100 rounded-lg p-1 self-start sm:self-auto">
                                        <button onClick={() => setHistoryCurrency('ALL')} className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${historyCurrency === 'ALL' ? 'bg-brand-navy text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Ambas</button>
                                        <button onClick={() => setHistoryCurrency('ARS')} className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${historyCurrency === 'ARS' ? 'bg-brand-navy text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Pesos ($)</button>
                                        <button onClick={() => setHistoryCurrency('USD')} className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${historyCurrency === 'USD' ? 'bg-brand-navy text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Dólares (US$)</button>
                                    </div>
                                </div>
                                <div className="h-[300px] sm:h-[350px] w-full mt-4">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={timelineData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                                            <defs>
                                                <linearGradient id="colorArs" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#0f172a" stopOpacity={0.6}/><stop offset="95%" stopColor="#0f172a" stopOpacity={0}/></linearGradient>
                                                <linearGradient id="colorUsd" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#b45309" stopOpacity={0.6}/><stop offset="95%" stopColor="#b45309" stopOpacity={0}/></linearGradient>
                                            </defs>
                                            <XAxis dataKey="date" tick={{fontSize: 10, fill: '#94a3b8'}} axisLine={false} tickLine={false} dy={10} />
                                            <YAxis tickFormatter={(val) => formatCompact(val)} tick={{fontSize: 10, fill: '#94a3b8'}} axisLine={false} tickLine={false} width={40}/>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <RechartsTooltip formatter={(value, name) => [formatCurrency(value), name]} contentStyle={{ borderRadius: '4px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)' }} />
                                            <Legend verticalAlign="top" height={36} iconType="circle" wrapperStyle={{fontSize: '10px'}}/>
                                            {(historyCurrency === 'ALL' || historyCurrency === 'ARS') && <Area type="monotone" dataKey="ARS" name="Pesos (ARS)" stroke="#0f172a" strokeWidth={2} fillOpacity={1} fill="url(#colorArs)" />}
                                            {(historyCurrency === 'ALL' || historyCurrency === 'USD') && <Area type="monotone" dataKey="USD" name="Dólares (USD)" stroke="#b45309" strokeWidth={2} fillOpacity={1} fill="url(#colorUsd)" />}
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                            </Card>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>