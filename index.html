<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="light">
    
    <title>Reporte de FCI | S&C Inversiones</title>
    <link rel="icon" href="https://www.cafci.org.ar/images/cabezal_logo.png" type="image/png">
    
    <!-- Fuentes y Librerías -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            navy: '#0f172a',
                            gold: '#b45309',
                            bg: '#f8fafc',
                            card: '#ffffff'
                        }
                    },
                    boxShadow: { 
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)'
                    }
                }
            }
        }
    </script>

    <style>
        :root { color-scheme: light; }
        body { background-color: #f8fafc; color: #0f172a; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // CONFIGURACIÓN
        // ==========================================
        const URL_TENENCIAS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2q5B__AcuBzjLoDUJPIrR0yyOa4BTcGuZjOMoJv9j55LsBTcKfFmai5qwkqAjsw/pub?gid=1204167854&single=true&output=csv";
        const URL_SUSCRIPCIONES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2q5B__AcuBzjLoDUJPIrR0yyOa4BTcGuZjOMoJv9j55LsBTcKfFmai5qwkqAjsw/pub?gid=1189224573&single=true&output=csv"; 
        const URL_RESCATES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2q5B__AcuBzjLoDUJPIrR0yyOa4BTcGuZjOMoJv9j55LsBTcKfFmai5qwkqAjsw/pub?gid=1665458748&single=true&output=csv";
        const LOGO_URL = "https://www.cafci.org.ar/images/cabezal_logo.png";

        // DATOS DEMO (Solo respaldo)
        const DEMO_TENENCIAS = `Moneda,Fecha,Cuenta,Unidad,Importe,FCI\nUSD,2025-01-01,A,Galileo Income,3457.58,GALILEO\nARS,2025-01-01,A,ADCAP RENT,242610.11,ADCAP\nUSD,2025-01-01,A,Galileo Event,14511.63,GALILEO`;
        const DEMO_SUSCRIPCIONES = `Moneda,Fecha,FCI,Importe\nARS,2025-05-15,ADCAP,500000\nUSD,2025-05-15,GALILEO,2000`;
        const DEMO_RESCATES = `Moneda,Fecha,FCI,Importe\nARS,2025-05-14,ADCAP,200000\nUSD,2025-05-16,GALILEO,1000`;

        const { useState, useEffect, useMemo, useCallback } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell, AreaChart, Area, ReferenceLine, LabelList } = Recharts;

        // --- ICONOS ---
        const Icon = ({ path, className }) => ( <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={path} /></svg> );
        const Icons = {
            Wallet: (props) => <Icon {...props} path="M20 7h-3a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h3a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM4 9h16" />,
            DollarSign: (props) => <Icon {...props} path="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />,
            PieChart: (props) => <Icon {...props} path="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z" />,
            Filter: (props) => <Icon {...props} path="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" />,
            Calendar: (props) => <Icon {...props} path="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zM16 2v4M8 2v4M3 10h18" />,
            RefreshCcw: (props) => <Icon {...props} path="M3 2v6h6M21 12A9 9 0 0 0 6 5.3L3 8M21 22v-6h-6M3 12a9 9 0 0 0 15 6.7l3-2.7" />,
            Loader2: (props) => <svg {...props} className={`animate-spin ${props.className}`} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>,
            ChevronDown: (props) => <Icon {...props} path="M6 9l6 6 6-6" />,
            ChevronRight: (props) => <Icon {...props} path="M9 18l6-6-6-6" />,
            TrendingUp: (props) => <Icon {...props} path="M23 6l-9.5 9.5-5-5L1 18" />,
            Activity: (props) => <Icon {...props} path="M22 12h-4l-3 9L9 3l-3 9H2" />
        };

        // --- COMPONENTES AUXILIARES ---
        const Card = ({ children, className = "" }) => ( <div className={`bg-white rounded-xl shadow-soft border border-slate-100 ${className}`}>{children}</div> );

        const StatCard = ({ title, value, prefix, icon: Icon }) => (
            <Card className="p-5 border-l-[6px] border-brand-navy relative overflow-hidden group hover:shadow-lg transition-all duration-300">
                <div className="mb-3 relative z-10 flex items-center justify-between">
                    <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest">{title}</h3>
                    <div className="text-brand-gold opacity-80"><Icon size={20}/></div>
                </div>
                <div className="flex items-baseline gap-1 relative z-10">
                    <span className="text-xl font-bold text-brand-gold">{prefix}</span>
                    <span className="text-3xl sm:text-4xl font-bold text-brand-navy tracking-tight">{value}</span>
                </div>
            </Card>
        );

        const CompactCell = ({ diffVal, pct }) => {
            const isPos = diffVal >= 0; 
            const colorClass = isPos ? 'text-emerald-600' : 'text-red-600';
            const bgClass = isPos ? 'bg-emerald-50' : 'bg-red-50';
            const sign = isPos ? '+' : '';

            return (
                <div className="flex flex-col items-end justify-center h-full">
                    <span className={`text-[10px] sm:text-xs font-bold ${colorClass} whitespace-nowrap`}>
                        {diffVal !== 0 ? `${sign}${formatCurrency(diffVal)}` : '-'}
                    </span>
                    <span className={`text-[9px] sm:text-[10px] font-bold ${colorClass} ${bgClass} px-1.5 py-0.5 rounded mt-0.5 whitespace-nowrap`}>
                        {formatPct(pct)}
                    </span>
                </div>
            );
        };

        const CustomFlowTooltip = ({ active, payload }) => {
            if (active && payload && payload.length) {
                const row = payload[0].payload;
                const subs = Math.abs(row.Subs || 0);
                const redem = Math.abs(row.RedemNegative || 0);
                const net = (row.Subs || 0) + (row.RedemNegative || 0);
                return (
                    <div className="bg-white border border-slate-200 rounded-lg p-3 shadow-lg text-xs z-50 relative">
                        <p className="font-bold text-slate-800 mb-2 border-b border-slate-100 pb-1">{row.name}</p>
                        <div className="text-emerald-600 font-medium">Suscripciones: {formatCurrency(subs)}</div>
                        <div className="text-red-600 font-medium">Rescates: {formatCurrency(redem)}</div>
                        <div className={`mt-2 pt-1 border-t border-slate-100 font-bold ${net >= 0 ? 'text-emerald-700' : 'text-red-700'}`}>Neto: {formatCurrency(net)}</div>
                    </div>
                );
            }
            return null;
        };

        const FilterBar = ({ title, currencies, managers, currencyVal, setCurrency, managerVal, setManager, startDate, setStartDate, endDate, setEndDate, reportDate, setReportDate, isRange = true, isFlow = false }) => (
            <div className="bg-white px-5 py-4 rounded-xl shadow-soft border border-slate-200 flex flex-col md:flex-row flex-wrap gap-4 items-end md:items-center mb-6">
                <div className="flex items-center gap-2 text-brand-navy font-bold w-full md:w-auto border-b md:border-b-0 pb-2 md:pb-0 md:pr-6 md:border-r border-slate-200">
                    <div className="p-1.5 bg-slate-100 rounded-md text-brand-navy"><Icons.Filter size={14} /></div>
                    <span className="text-sm">{title}</span>
                </div>
                {!isFlow && (
                    <div className="grid grid-cols-2 gap-3 w-full md:w-auto md:flex md:gap-4">
                        <div className="flex flex-col gap-1 w-full md:w-auto col-span-1">
                            <label className="text-[10px] text-slate-500 font-bold uppercase ml-1">Moneda</label>
                            <select value={currencyVal} onChange={(e) => setCurrency(e.target.value)} className="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg hover:border-brand-gold focus:ring-1 focus:ring-brand-gold block p-2 outline-none w-full transition-colors">
                                {currencies.map(c => <option key={c} value={c}>{c === 'TODAS' ? 'Todas' : c}</option>)}
                            </select>
                        </div>
                        <div className="flex flex-col gap-1 w-full md:w-auto col-span-1">
                            <label className="text-[10px] text-slate-500 font-bold uppercase ml-1">FAMILIA</label>
                            <select value={managerVal} onChange={(e) => setManager(e.target.value)} className="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg hover:border-brand-gold focus:ring-1 focus:ring-brand-gold block p-2 outline-none w-full md:w-48 transition-colors">
                                {managers.map(m => <option key={m} value={m}>{m === 'TODAS' ? 'Todas' : m}</option>)}
                            </select>
                        </div>
                    </div>
                )}
                {isRange ? (
                    <div className="grid grid-cols-2 gap-3 w-full md:w-auto md:flex md:gap-4">
                        <div className="flex flex-col gap-1 w-full md:w-auto">
                            <label className="text-[10px] text-slate-500 font-bold uppercase ml-1">Desde</label>
                            <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg hover:border-brand-gold focus:ring-1 focus:ring-brand-gold block p-2 outline-none w-full"/>
                        </div>
                        <div className="flex flex-col gap-1 w-full md:w-auto">
                            <label className="text-[10px] text-slate-500 font-bold uppercase ml-1">Hasta</label>
                            <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg hover:border-brand-gold focus:ring-1 focus:ring-brand-gold block p-2 outline-none w-full"/>
                        </div>
                    </div>
                ) : (
                    <div className="flex flex-col gap-1 w-full md:w-auto">
                        <label className="text-[10px] text-slate-500 font-bold uppercase ml-1 flex items-center gap-1"><Icons.Calendar size={10}/> Fecha de Reporte</label>
                        <input type="date" value={reportDate} onChange={(e) => setReportDate(e.target.value)} className="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg hover:border-brand-gold focus:ring-1 focus:ring-brand-gold block p-2 outline-none font-bold w-full"/>
                    </div>
                )}
                <button onClick={() => { setCurrency('TODAS'); setManager('TODAS'); if(isRange) { setStartDate(''); setEndDate(''); } }} className="w-full md:w-auto ml-auto text-xs font-semibold text-brand-gold hover:text-white border border-brand-gold hover:bg-brand-gold flex items-center justify-center gap-2 px-4 py-2 rounded-lg transition-all mt-2 md:mt-0">
                    <Icons.RefreshCcw size={12}/> Reiniciar
                </button>
            </div>
        );

        // --- HELPERS Y PARSERS ---
        // Genera un string de fecha "YYYY-MM-DD" seguro y comparable
        const normalizeDateStr = (val) => {
            if (!val) return null;
            if (typeof val === 'number') {
                const date = new Date((val - (25567 + 2)) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            if (typeof val === 'string') {
                const clean = val.trim();
                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(clean)) {
                    const [d, m, y] = clean.split('/');
                    return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                }
                if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(clean)) {
                     return clean; 
                }
            }
            return null;
        };

        const formatDateString = (dateObj) => { 
            if (!dateObj || isNaN(dateObj)) return ''; 
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const normalizeCurrency = (curr) => { 
            if (!curr) return 'OTHER'; 
            const c = String(curr).toUpperCase().trim(); 
            if (c === 'ARS' || c === 'PESOS' || c === 'PESO' || c === '$') return 'ARS'; 
            if (c === 'USD' || c === 'USDM' || c === 'DOLARES' || c === 'DOLAR' || c === 'U$S' || c === 'US$') return 'USD'; 
            return 'OTHER'; 
        };

        // Parser Robustecido
        const parseCSV = (text) => {
            const lines = text.trim().split('\n'); if (lines.length < 2) return [];
            const separator = lines[0].includes(';') ? ';' : ',';
            
            const splitLine = (line) => {
                const result = []; let current = ''; let insideQuotes = false;
                for (let i = 0; i < line.length; i++) { 
                    const char = line[i]; 
                    if (char === '"') insideQuotes = !insideQuotes; 
                    else if (char === separator && !insideQuotes) { result.push(current.trim()); current = ''; } 
                    else current += char; 
                }
                result.push(current.trim()); return result;
            };
            
            const headers = splitLine(lines[0]).map(h => h.toLowerCase().replace(/['"]+/g, '').trim());
            const findValue = (rowObj, aliases) => { for (let alias of aliases) if (rowObj[alias] !== undefined) return rowObj[alias]; return ''; };
            
            return lines.slice(1).map(line => {
                if (!line.trim()) return null; 
                const values = splitLine(line); 
                const entry = {};
                headers.forEach((h, i) => { let val = values[i] ? values[i].replace(/^"|"$/g, '') : ''; entry[h] = val; });
                
                let rawImporte = findValue(entry, ['importe', 'valor', 'monto', 'saldo']);
                if (typeof rawImporte === 'string') rawImporte = rawImporte.replace(/[$.]/g, '').replace(',', '.');
                
                const rawMoneda = findValue(entry, ['moneda']);
                const normalizedMoneda = normalizeCurrency(rawMoneda);
                
                let rawFci = findValue(entry, ['fci', 'administradora', 'fondos.fci', 'sociedad gerente', 'familia', 'family']) || 'OTRO';
                rawFci = rawFci.toUpperCase().trim();
                
                let detalle = findValue(entry, ['detalle', 'descripcion', 'nombre', 'fondo detalle']);
                
                const rawFecha = findValue(entry, ['fecha']);
                const dateStr = normalizeDateStr(rawFecha); // Fecha normalizada YYYY-MM-DD

                return { 
                    Moneda: normalizedMoneda, 
                    dateStr: dateStr, // Clave para filtrado exacto
                    Fecha: rawFecha,
                    Unidad: findValue(entry, ['unidad', 'fondo', 'especie', 'activo']), 
                    Importe: parseFloat(rawImporte || 0), 
                    FCI: rawFci, 
                    Detalle: detalle 
                };
            }).filter(item => item && !isNaN(item.Importe) && item.dateStr);
        };

        const formatCurrency = (val) => new Intl.NumberFormat('es-AR', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
        const formatCompact = (val) => new Intl.NumberFormat('es-AR', { notation: "compact", compactDisplay: "short" }).format(val);
        const formatPct = (val) => { if (val === 0 || isNaN(val)) return '-'; const sign = val > 0 ? '+' : ''; return `${sign}${val.toFixed(2)}%`; };

        // --- APP PRINCIPAL ---
        function App() {
            const [data, setData] = useState([]);
            const [dataSubs, setDataSubs] = useState([]);
            const [dataRedem, setDataRedem] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            
            const [totalCurrency, setTotalCurrency] = useState('TODAS');
            const [totalManager, setTotalManager] = useState('TODAS');
            const [reportDate, setReportDate] = useState('');
            const [flowStart, setFlowStart] = useState('');
            const [flowEnd, setFlowEnd] = useState('');
            const [expandedFamilies, setExpandedFamilies] = useState([]);
            const [volumeCurrency, setVolumeCurrency] = useState('ARS'); 
            const [tableCurrency, setTableCurrency] = useState('ARS');

            const toggleFamily = (familyName) => { setExpandedFamilies(prev => prev.includes(familyName) ? prev.filter(f => f !== familyName) : [...prev, familyName]); };

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                async function fetchAll() {
                    setLoading(true);
                    try {
                        let csvTenencias = DEMO_TENENCIAS;
                        if (URL_TENENCIAS) { const res = await fetch(URL_TENENCIAS); if(res.ok) csvTenencias = await res.text(); }
                        const parsedData = parseCSV(csvTenencias); setData(parsedData);
                        if (parsedData.length > 0) {
                            // Encontrar la fecha máxima real
                            const dates = parsedData.map(d => d.dateStr).sort();
                            const maxDateStr = dates[dates.length - 1];
                            
                            if (maxDateStr) {
                                setReportDate(maxDateStr);
                                setFlowEnd(maxDateStr);
                                
                                // Calcular 30 días atrás de forma segura
                                const [y, m, d] = maxDateStr.split('-').map(Number);
                                const dObj = new Date(y, m-1, d);
                                dObj.setDate(dObj.getDate() - 30);
                                setFlowStart(formatDateString(dObj));
                            }
                        }
                        let csvSubs = DEMO_SUSCRIPCIONES; if (URL_SUSCRIPCIONES) { const res = await fetch(URL_SUSCRIPCIONES); if(res.ok) csvSubs = await res.text(); } setDataSubs(parseCSV(csvSubs));
                        let csvRedem = DEMO_RESCATES; if (URL_RESCATES) { const res = await fetch(URL_RESCATES); if(res.ok) csvRedem = await res.text(); } setDataRedem(parseCSV(csvRedem));
                    } catch (err) { console.error(err); } finally { setLoading(false); }
                }
                fetchAll();
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const currencies = useMemo(() => ['TODAS', ...new Set(data.map(d => d.Moneda))].filter(Boolean), [data]);
            const managers = useMemo(() => ['TODAS', ...new Set(data.map(d => d.FCI))].filter(Boolean), [data]);

            // Helper centralizado para saldos EXACTOS a una fecha (String Match)
            const getBalancesAtDate = useCallback((targetDateStr, targetCurrency, targetManager) => {
                if (!targetDateStr) return {};
                
                // Filtramos por fecha exacta usando el string normalizado
                let relevantData = data.filter(d => d.dateStr === targetDateStr);
                
                if (targetCurrency !== 'TODAS') relevantData = relevantData.filter(d => d.Moneda === targetCurrency);
                if (targetManager !== 'TODAS') relevantData = relevantData.filter(d => d.FCI === targetManager);

                const familyGroups = {};
                relevantData.forEach(d => {
                    const family = d.FCI || 'OTROS';
                    if (!familyGroups[family]) familyGroups[family] = 0;
                    familyGroups[family] += d.Importe;
                });
                return familyGroups;
            }, [data]);

            // Stats KPI (Filtrado por fecha exacta de reporte)
            const stats = useMemo(() => {
                const dailyData = data.filter(d => d.dateStr === reportDate);
                const totalImporteARS = dailyData.filter(d => d.Moneda === 'ARS').reduce((acc, curr) => acc + curr.Importe, 0);
                const totalImporteUSD = dailyData.filter(d => d.Moneda === 'USD').reduce((acc, curr) => acc + curr.Importe, 0);
                return { totalImporteARS, totalImporteUSD };
            }, [data, reportDate]);

            // Chart Data - Usa getBalancesAtDate (estricto)
            const managerData = useMemo(() => {
                const balances = getBalancesAtDate(reportDate, volumeCurrency, totalManager);
                return Object.entries(balances)
                    .map(([name, value]) => ({ name, value }))
                    .filter(item => item.value > 0)
                    .sort((a, b) => b.value - a.value);
            }, [getBalancesAtDate, reportDate, volumeCurrency, totalManager]);

            // Table Data - Usa getBalancesAtDate (estricto)
            const groupedVariations = useMemo(() => {
                if (data.length === 0 || !reportDate) return [];
                
                const [y, m, d] = reportDate.split('-').map(Number);
                const refDateObj = new Date(y, m-1, d);

                const d7 = new Date(refDateObj); d7.setDate(d7.getDate() - 7);
                const d28 = new Date(refDateObj); d28.setDate(d28.getDate() - 28);
                const dYTD = new Date(refDateObj.getFullYear(), 0, 1);

                // Saldos Totales por Familia
                const currentBalances = getBalancesAtDate(reportDate, tableCurrency, totalManager);
                const balances7d = getBalancesAtDate(formatDateString(d7), tableCurrency, totalManager);
                const balances28d = getBalancesAtDate(formatDateString(d28), tableCurrency, totalManager);
                const balancesYTD = getBalancesAtDate(formatDateString(dYTD), tableCurrency, totalManager);

                // Para detalle fondos
                const getFundValAt = (targetDateStr, fundName) => {
                     let val = 0;
                     const targetData = data.filter(d => 
                        d.dateStr === targetDateStr 
                        && d.Unidad.trim() === fundName 
                        && d.Moneda === tableCurrency
                     );
                     targetData.forEach(d => val += d.Importe);
                     return val;
                };

                const currentDayData = data.filter(d => 
                    d.dateStr === reportDate 
                    && d.Moneda === tableCurrency 
                    && (totalManager === 'TODAS' || d.FCI === totalManager)
                );
                
                const fundsInCurrentDay = [...new Set(currentDayData.map(d => d.Unidad.trim()))];

                const groups = Object.keys(currentBalances).map(familyName => {
                    const current = currentBalances[familyName] || 0;
                    if (current === 0) return null;
                    const v7 = balances7d[familyName] || 0; const v28 = balances28d[familyName] || 0; const vYTD = balancesYTD[familyName] || 0;
                    return {
                        name: familyName, current: current,
                        diff7d: current - v7, pct7d: v7 > 0 ? ((current - v7) / v7) * 100 : 0,
                        diff28d: current - v28, pct28d: v28 > 0 ? ((current - v28) / v28) * 100 : 0,
                        diffYTD: current - vYTD, pctYTD: vYTD > 0 ? ((current - vYTD) / vYTD) * 100 : 0,
                        funds: [] 
                    };
                }).filter(Boolean);

                groups.forEach(group => {
                     const groupFundsNames = fundsInCurrentDay.filter(fname => {
                         const fundRow = currentDayData.find(d => d.Unidad.trim() === fname);
                         return fundRow && (fundRow.FCI || 'OTROS') === group.name;
                     });

                     group.funds = groupFundsNames.map(fname => {
                        const current = getFundValAt(reportDate, fname);
                        if (current === 0) return null;
                        
                        const v7 = getFundValAt(formatDateString(d7), fname);
                        const v28 = getFundValAt(formatDateString(d28), fname);
                        const vYTD = getFundValAt(formatDateString(dYTD), fname);
                        
                        const meta = currentDayData.find(d => d.Unidad.trim() === fname);
                        const displayName = meta.Detalle && meta.Detalle.length > 2 ? meta.Detalle : fname;

                        return {
                            name: displayName, moneda: tableCurrency, current: current,
                            diff7d: current - v7, pct7d: v7 > 0 ? ((current - v7) / v7) * 100 : 0,
                            diff28d: current - v28, pct28d: v28 > 0 ? ((current - v28) / v28) * 100 : 0,
                            diffYTD: current - vYTD, pctYTD: vYTD > 0 ? ((current - vYTD) / vYTD) * 100 : 0,
                        };
                     }).filter(Boolean).sort((a,b) => b.current - a.current);
                });

                return groups.sort((a,b) => b.current - a.current);
            }, [data, tableCurrency, totalManager, reportDate, getBalancesAtDate]);

            // Evolución Histórica
            const timelineData = useMemo(() => {
                if (totalManager !== 'TODAS') {
                     // Si hay filtro de manager, filtramos data base
                     const filtered = data.filter(d => d.FCI === totalManager);
                     // Agrupar por fecha
                     const grouped = {};
                     filtered.forEach(d => {
                         if (!grouped[d.dateStr]) grouped[d.dateStr] = { date: d.dateStr, ARS: 0, USD: 0 };
                         if (d.Moneda === 'ARS') grouped[d.dateStr].ARS += d.Importe;
                         if (d.Moneda === 'USD') grouped[d.dateStr].USD += d.Importe;
                     });
                     return Object.values(grouped).sort((a,b) => a.date.localeCompare(b.date));
                }
                
                // Si no hay filtro, agrupar todo
                const grouped = {};
                data.forEach(d => {
                     if (!grouped[d.dateStr]) grouped[d.dateStr] = { date: d.dateStr, ARS: 0, USD: 0 };
                     if (d.Moneda === 'ARS') grouped[d.dateStr].ARS += d.Importe;
                     if (d.Moneda === 'USD') grouped[d.dateStr].USD += d.Importe;
                });
                return Object.values(grouped).sort((a,b) => a.date.localeCompare(b.date));
            }, [data, totalManager]);

            // Flujo de Fondos
            const flowData = useMemo(() => {
                const aggregations = {};
                const processFlow = (dataset, type) => {
                    dataset.forEach(row => {
                        // Filtros de Flujo
                        if (volumeCurrency === 'ARS' && row.Moneda !== 'ARS') return; // Usamos volumeCurrency como filtro de moneda
                        if (volumeCurrency === 'USD' && row.Moneda !== 'USD') return;
                        if (totalManager !== 'TODAS' && row.FCI !== totalManager) return;
                        
                        // Filtro de Fecha (String compare es seguro con formato YYYY-MM-DD)
                        if (row.dateStr < flowStart || row.dateStr > flowEnd) return;

                        const mgr = row.FCI || 'OTROS';
                        if (!aggregations[mgr]) aggregations[mgr] = { name: mgr, Subs: 0, Redem: 0 };
                        
                        const val = Math.abs(row.Importe);
                        
                        if (type === 'sub') aggregations[mgr].Subs += val;
                        if (type === 'red') aggregations[mgr].Redem -= val; 
                    });
                };
                processFlow(dataSubs, 'sub'); processFlow(dataRedem, 'red');
                return Object.values(aggregations).map(item => ({ ...item, RedemNegative: item.Redem })).filter(item => item.Subs > 0 || item.Redem < 0).sort((a,b) => (b.Subs + Math.abs(b.Redem)) - (a.Subs + Math.abs(a.Redem)));
            }, [dataSubs, dataRedem, volumeCurrency, totalManager, flowStart, flowEnd]); // Reutilizamos volumeCurrency para simplicidad o agregamos otro estado

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500"><Icons.Loader2 className="mr-2"/> Cargando...</div>;

            return (
                <div className="min-h-screen bg-brand-bg font-sans pb-12 fade-in">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-20 px-6 py-4 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-6 max-w-7xl mx-auto w-full">
                            <img src={LOGO_URL} alt="S&C Inversiones" className="h-10 object-contain" onError={(e) => e.target.style.display = 'none'} />
                            <div className="h-8 w-px bg-slate-200"></div>
                            <div>
                                <h1 className="text-xl font-bold text-brand-navy tracking-tight">REPORTE DE FCI</h1>
                                <p className="text-[10px] text-gray-500 uppercase tracking-widest font-semibold">Resumen de Cartera</p>
                            </div>
                        </div>
                    </header>

                    <main className="p-6 max-w-7xl mx-auto space-y-8 mt-4">
                        
                        {/* KPI Section */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <StatCard title="TOTAL PESOS" value={formatCurrency(stats.totalImporteARS)} prefix="$" icon={Icons.Wallet} />
                            <StatCard title="TOTAL DÓLARES" value={formatCurrency(stats.totalImporteUSD)} prefix="US$" icon={Icons.DollarSign} />
                        </div>

                        {/* Filtros */}
                        <div>
                            <FilterBar title="Filtros Generales" currencies={currencies} managers={managers} currencyVal={totalCurrency} setCurrency={setTotalCurrency} managerVal={totalManager} setManager={setTotalManager} startDate={null} setStartDate={null} endDate={null} setEndDate={null} reportDate={reportDate} setReportDate={setReportDate} isRange={false} />
                        </div>

                        {/* Fila 1: Saldo en Custodia */}
                        <div className="grid grid-cols-1 mb-8">
                            <Card className="p-6">
                                <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 border-b border-slate-100 pb-3 gap-3">
                                    <h3 className="text-base font-bold text-brand-navy flex items-center gap-2"><Icons.PieChart className="text-brand-gold" />Saldo en Custodia por Familia</h3>
                                    <div className="flex bg-slate-100 rounded-lg p-1 self-start sm:self-auto">
                                        <button onClick={() => setVolumeCurrency('ARS')} className={`px-4 py-1.5 text-xs font-medium rounded-md transition-all ${volumeCurrency === 'ARS' ? 'bg-brand-navy text-white shadow' : 'text-slate-500 hover:text-slate-700'}`}>PESOS ($)</button>
                                        <button onClick={() => setVolumeCurrency('USD')} className={`px-4 py-1.5 text-xs font-medium rounded-md transition-all ${volumeCurrency === 'USD' ? 'bg-brand-gold text-white shadow' : 'text-slate-500 hover:text-slate-700'}`}>DÓLARES (US$)</button>
                                    </div>
                                </div>
                                <div className="h-[350px] w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={managerData} margin={{ top: 10, right: 10, left: 10, bottom: 30 }}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <XAxis 
                                                dataKey="name" 
                                                tick={!isMobile ? {fontSize: 11, fill: '#1e293b'} : false} 
                                                interval={0} 
                                                angle={-45} 
                                                textAnchor="end" 
                                                height={80} 
                                                tickFormatter={(val) => val.length > 15 ? val.substring(0, 15) + '..' : val} 
                                            />
                                            <YAxis tickFormatter={(val) => formatCompact(val)} tick={{fontSize: 11, fill: '#64748b'}} axisLine={false} tickLine={false} width={40} />
                                            <RechartsTooltip cursor={{fill: '#f1f5f9'}} formatter={(value) => [formatCurrency(value), volumeCurrency === 'ARS' ? 'Total $' : 'Total US$']} contentStyle={{ borderRadius: '6px', border: '1px solid #e2e8f0', boxShadow: '0 4px 10px rgba(0,0,0,0.05)' }} />
                                            <Bar dataKey="value" fill={volumeCurrency === 'ARS' ? '#0f172a' : '#b45309'} radius={[4, 4, 0, 0]} maxBarSize={60} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </Card>
                        </div>

                        {/* Tabla de Rendimiento */}
                        <div className="grid grid-cols-1 gap-6 mb-10">
                            <Card className="overflow-hidden">
                                <div className="px-6 py-4 border-b border-slate-200 bg-white flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                                    <div className="flex items-center gap-3">
                                        <h3 className="text-base font-bold text-brand-navy flex items-center gap-2"><Icons.TrendingUp className="text-brand-gold" />Variación por Familia</h3>
                                        <span className="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded border border-slate-200">DETALLE DE FONDOS</span>
                                    </div>
                                    <div className="flex bg-slate-100 rounded-lg p-1 self-start sm:self-auto">
                                        <button onClick={() => setTableCurrency('ARS')} className={`px-4 py-1.5 text-xs font-medium rounded-md transition-all ${tableCurrency === 'ARS' ? 'bg-brand-navy text-white shadow' : 'text-slate-500 hover:text-slate-700'}`}>PESOS ($)</button>
                                        <button onClick={() => setTableCurrency('USD')} className={`px-4 py-1.5 text-xs font-medium rounded-md transition-all ${tableCurrency === 'USD' ? 'bg-brand-gold text-white shadow' : 'text-slate-500 hover:text-slate-700'}`}>DÓLARES (US$)</button>
                                    </div>
                                </div>
                                <div className="overflow-x-auto custom-scrollbar">
                                    <table className="w-full text-xs sm:text-sm text-left text-slate-600">
                                        <thead className="text-[10px] uppercase bg-slate-50 border-b border-slate-200 text-slate-500 font-bold tracking-wide">
                                            <tr>
                                                <th className="px-3 py-3 text-left w-1/3">Familia / Fondo</th>
                                                <th className="px-2 py-3 text-right">Actual</th>
                                                <th className="px-2 py-3 text-right">7D</th>
                                                <th className="px-2 py-3 text-right">28D</th>
                                                <th className="px-2 py-3 text-right">YTD</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100 bg-white">
                                            {groupedVariations.map((family) => (
                                                <React.Fragment key={family.name}>
                                                    <tr className="bg-white text-slate-900 cursor-pointer transition-colors border-b border-slate-100 hover:bg-slate-50" onClick={() => toggleFamily(family.name)}>
                                                        <td className="px-3 py-3 flex items-center gap-2 font-bold text-brand-navy">
                                                            {expandedFamilies.includes(family.name) ? <Icons.ChevronDown size={12} className="text-brand-gold"/> : <Icons.ChevronRight size={12} className="text-brand-gold"/>}
                                                            <span className="truncate max-w-[120px] sm:max-w-none">{family.name}</span>
                                                        </td>
                                                        <td className="px-2 py-3 text-right font-bold text-slate-900">{formatCurrency(family.current)}</td>
                                                        <td className="px-2 py-3 text-right"><CompactCell diffVal={family.diff7d} pct={family.pct7d}/></td>
                                                        <td className="px-2 py-3 text-right"><CompactCell diffVal={family.diff28d} pct={family.pct28d}/></td>
                                                        <td className="px-2 py-3 text-right"><CompactCell diffVal={family.diffYTD} pct={family.pctYTD}/></td>
                                                    </tr>
                                                    {expandedFamilies.includes(family.name) && family.funds.map(fund => (
                                                        <tr key={fund.name} className="bg-slate-50/50 hover:bg-slate-100 border-b border-slate-100 text-[11px] transition-colors">
                                                            <td className="px-3 py-2 pl-8 border-l-2 border-slate-200 text-slate-600">
                                                                <div className="font-medium truncate max-w-[150px] sm:max-w-none" title={fund.name}>{fund.name}</div>
                                                                <div className="text-[9px] text-slate-400 font-mono mt-0.5">{fund.moneda}</div>
                                                            </td>
                                                            <td className="px-2 py-2 text-right text-slate-700 font-medium">{formatCurrency(fund.current)}</td>
                                                            <td className="px-2 py-2 text-right"><CompactCell diffVal={fund.diff7d} pct={fund.pct7d}/></td>
                                                            <td className="px-2 py-2 text-right"><CompactCell diffVal={fund.diff28d} pct={fund.pct28d}/></td>
                                                            <td className="px-2 py-2 text-right"><CompactCell diffVal={fund.diffYTD} pct={fund.pctYTD}/></td>
                                                        </tr>
                                                    ))}
                                                </React.Fragment>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>

                         {/* Evolución Histórica */}
                        <div className="grid grid-cols-1 mb-10">
                            <Card className="p-5 sm:p-6">
                                <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 border-b border-slate-100 pb-3 gap-3">
                                    <h3 className="text-base font-bold text-brand-navy flex items-center gap-2"><Icons.TrendingUp className="text-brand-gold" />Evolución Histórica</h3>
                                </div>
                                <div className="h-[450px] w-full mt-4">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={timelineData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                                            <defs>
                                                <linearGradient id="colorArs" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#0f172a" stopOpacity={0.6}/><stop offset="95%" stopColor="#0f172a" stopOpacity={0}/></linearGradient>
                                                <linearGradient id="colorUsd" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#b45309" stopOpacity={0.6}/><stop offset="95%" stopColor="#b45309" stopOpacity={0}/></linearGradient>
                                            </defs>
                                            <XAxis dataKey="date" tick={{fontSize: 11, fill: '#94a3b8'}} axisLine={false} tickLine={false} dy={10} />
                                            <YAxis tickFormatter={(val) => formatCompact(val)} tick={{fontSize: 11, fill: '#94a3b8'}} axisLine={false} tickLine={false} width={40}/>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <RechartsTooltip formatter={(value, name) => [formatCurrency(value), name === 'ARS' ? 'Pesos' : 'Dólares']} contentStyle={{ borderRadius: '6px', border: 'none', boxShadow: '0 4px 10px rgba(0,0,0,0.05)' }} />
                                            <Legend verticalAlign="top" height={36} iconType="circle" wrapperStyle={{fontSize: '11px'}}/>
                                            <Area type="monotone" dataKey="ARS" name="Pesos (ARS)" stroke="#0f172a" strokeWidth={2} fillOpacity={1} fill="url(#colorArs)" />
                                            <Area type="monotone" dataKey="USD" name="Dólares (USD)" stroke="#b45309" strokeWidth={2} fillOpacity={1} fill="url(#colorUsd)" />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                            </Card>
                        </div>

                        {/* SECCIÓN FLUJO DE FONDOS (AL FINAL) */}
                        <div className="grid grid-cols-1 mb-8">
                            <Card className="p-5 sm:p-6">
                                <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 border-b border-slate-100 pb-3 gap-3">
                                    <h3 className="text-base font-bold text-brand-navy flex items-center gap-2"><Icons.Activity className="text-brand-gold" />Flujo de Fondos (Suscripciones vs Rescates)</h3>
                                </div>
                                <FilterBar title="Rango de Fechas" currencies={currencies} managers={managers} currencyVal={totalCurrency} setCurrency={setTotalCurrency} managerVal={totalManager} setManager={setTotalManager} startDate={flowStart} setStartDate={setFlowStart} endDate={flowEnd} setEndDate={setFlowEnd} isRange={true} isFlow={true} />
                                <div className="h-[350px] w-full mt-6">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={flowData} margin={{ top: 20, right: 10, left: 10, bottom: 30 }} stackOffset="sign">
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <XAxis dataKey="name" tick={!isMobile ? {fontSize: 11, fill: '#64748b'} : false} interval={0} angle={-45} textAnchor="end" height={60} />
                                            <YAxis tickFormatter={(val) => formatCompact(Math.abs(val))} tick={{fontSize: 11, fill: '#64748b'}} axisLine={false} tickLine={false} width={40}/>
                                            <RechartsTooltip content={<CustomFlowTooltip />} />
                                            <Legend verticalAlign="top" height={36} iconType="circle" wrapperStyle={{fontSize: '11px'}}/>
                                            <ReferenceLine y={0} stroke="#cbd5e1" strokeWidth={2} />
                                            <Bar name="Suscripciones" dataKey="Subs" stackId="a" fill="#059669" radius={[4, 4, 0, 0]} maxBarSize={60} />
                                            <Bar name="Rescates" dataKey="RedemNegative" stackId="a" fill="#dc2626" radius={[0, 0, 4, 4]} maxBarSize={60} /> 
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </Card>
                        </div>
                        <div className="text-center py-6 text-[10px] text-slate-400 border-t border-slate-200 mt-8">
                            <p>© 2025 S&C Inversiones - Reporte generado automáticamente</p>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>